---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.7.1
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python}
# %matplotlib inline

import os
import sys
import glob
import time
from importlib import reload

# Specific science modules
import healpy as hp
import matplotlib.pyplot as plt
from matplotlib.legend_handler import HandlerLine2D, HandlerTuple
import matplotlib.ticker as mtick
import numpy as np
import pickle 
import astropy.io as fits

# Specific qubic modules
import qubic
from qubic.polyacquisition import compute_freq
from qubic import ReadMC as rmc
import ForegroundsSED as fsed
import qubic.AnalysisMC as amc

from pysimulators import FitsArray
from scipy.optimize import curve_fit
import scipy.constants
from qubic import mcmc
import qubic.AnalysisMC as amc
import pickle as pk

plt.rc('text',usetex=False)
plt.rc('font', size=16)
```

```{python}
nside = 64
savefigs = True
logscale = True
nreals = 43
component = "polarization"
# pixels used in paper:
if component == "intensity":
    #For Intensity
    pixQ_ud, pixG_ud = 47149, 26754
elif component == "polarization":
    # For Polarization
    pixQ_ud, pixG_ud = 42505, 27776
```

```{python}
file = open("DataSED/FI-component_data.pk", 'rb')
dictionaries, centers = pk.load(file)
file.close()

_, nus_edge150, nus150, _, _, _ = qubic.compute_freq(dictionaries[0]['filter_nu'] / 1e9,  
                            dictionaries[0]['nf_recon'],
                            dictionaries[0]['filter_relative_bandwidth'])
_, nus_edge220, nus220, _, _, _ = qubic.compute_freq(dictionaries[1]['filter_nu'] / 1e9,  
                            dictionaries[1]['nf_recon'],
                            dictionaries[1]['filter_relative_bandwidth'])


bandreg = ["Qubic_Field150FI", "Qubic_Field220FI",
           "GalCen_Field150FI", "GalCen_Field220FI"]
Cp_prime = []
for j, idict in enumerate(dictionaries):
    file = open("DataSED/SED_CovarMatrix_config{}_nside{}_nreals{}.pk".format(bandreg[j], 
                                                                                   nside,
                                                                                   nreals), "rb")
    Cp_prime.append(pk.load(file))
    file.close()
```

```{python}
file = open("DataSED/MCMC_run_{}nside{}_nreals{}_pixG{}_pixQ{}.pk".format(dictionaries[0]["config"],
                                                                  nside,
                                                                nreals,
                                                                pixG_ud, pixQ_ud), "rb")
Mean_mcmc, Std_mcmc, xarr_mcmc, ySED_fit, Pmean, Perr, pixs_ud = pk.load(file)
file.close()
```

```{python}
file = open("DataSED/ForegroundMaps_{}nside{}.pk".format(dictionaries[0]["config"],
                                                                  nside), "rb")
fgr_map_dust_ud, fgr_map_synch_ud, fgr_map_ud, maps_ud, cov_ud = pk.load(file)
file.close()
```

```{python}
#
#                  Intensity
#
# NEW (17 feb 2021)
RESO = 15
capsize = 3
fonts = 16
plt.rc('font', size = fonts)

fig,ax = plt.subplots(nrows = 1, ncols = 4,figsize = (19,4.5), gridspec_kw = {'wspace': 0.4})
ax = ax.ravel()
plt.subplots_adjust(wspace = 0.1)
# Plotting
# Dust galactic center
t0, = ax[0].plot(nus150, fgr_map_dust_ud[2,:,pixs_ud[2],0], ls = '', 
           marker = 'd', color = 'g',alpha = 0.5, label = 'Dust')
ax[0].plot(nus220, fgr_map_dust_ud[3,:,pixs_ud[2],0], marker = 'd', ls = '', color = 'g', alpha = 0.5)
#Synch galactic center
t1, = ax[0].plot(nus150, fgr_map_synch_ud[2,:,pixs_ud[2],0], ls = '', 
           marker = 's', color = 'g', alpha = 0.5, label = 'Synchrotron')
ax[0].plot(nus220, fgr_map_synch_ud[3,:,pixs_ud[2],0], marker = 's', ls = '', color = 'g', alpha = 0.5)
#Two components
p1, = ax[0].plot(nus150, fgr_map_ud[2, :, pixs_ud[2], 0], 'ro', label = 'Input sky')
p2, = ax[0].plot(nus220, fgr_map_ud[3, :, pixs_ud[2], 0], 'bo')


e1 = ax[0].fill_between(xarr_mcmc[2,:], y1 = ySED_fit[2,:,0] - Std_mcmc[2, :, 0], 
                                y2 = ySED_fit[2, :, 0] + Std_mcmc[2, :, 0], 
                 color = 'r', alpha = 0.3, label = '68% C.L.')
e2 = ax[0].fill_between(xarr_mcmc[3, :], y1 = ySED_fit[3, :, 0] - Std_mcmc[3, :, 0], 
                        y2 = ySED_fit[3, :, 0] + Std_mcmc[3, :, 0], 
                   color = 'b', alpha = 0.3)

# Dust galactic center
ax[2].plot(nus150, fgr_map_dust_ud[0,:,pixs_ud[0],0], ls = '', 
           marker = 'd', color = 'g',alpha = 0.5, label = 'Dust')
ax[2].plot(nus220, fgr_map_dust_ud[1,:,pixs_ud[0],0], marker = 'd', ls = '', color = 'g', alpha = 0.5)
#Synch galactic center
ax[2].plot(nus150, fgr_map_synch_ud[0,:,pixs_ud[0],0], ls = '', 
           marker = 's', color = 'g', alpha = 0.5, label = 'Synchrotron')
ax[2].plot(nus220, fgr_map_synch_ud[1,:,pixs_ud[0],0], marker = 's', ls = '', color = 'g', alpha = 0.5)

ax[2].plot(nus150, fgr_map_ud[0, :, pixs_ud[0], 0], 'ro')
ax[2].plot(nus220, fgr_map_ud[1, :, pixs_ud[0], 0], 'bo')
ax[2].fill_between(xarr_mcmc[0, :], y1 = ySED_fit[0, :, 0] - Std_mcmc[0, :, 0], 
                   y2 = ySED_fit[0, :, 0] + Std_mcmc[0, :, 0], 
                   color = 'r', alpha = 0.3)
ax[2].fill_between(xarr_mcmc[1, :], y1 = ySED_fit[1, :, 0] - Std_mcmc[1, :, 0], 
                   y2 = ySED_fit[1, :, 0] + Std_mcmc[1, :, 0], 
                   color = 'b', alpha = 0.3)

# Settings
greyscale = 0.1

ax[2].axvspan(nus_edge150[-1], nus_edge220[0],color='k',alpha = greyscale)
ax[0].axvspan(nus_edge150[-1], nus_edge220[0],color='k',alpha = greyscale)
xlim = ax[0].get_xlim()
ylim = ax[0].get_ylim()
xlim2 = ax[2].get_xlim()
ylim2 = ax[2].get_ylim()
ax[0].axvspan(xlim[0], nus_edge150[0], color = 'k', alpha = greyscale)
ax[0].axvspan(nus_edge220[-1], xlim[-1], color = 'k', alpha = greyscale)

ax[2].axvspan(xlim2[0], nus_edge150[0], color = 'k', alpha = greyscale)
ax[2].axvspan(nus_edge220[-1], xlim2[-1], color = 'k', alpha = greyscale)

if logscale:
    ax[0].set_yscale("log")
    ax[2].set_yscale("log")
    ax[0].set_xscale("log")
    ax[2].set_xscale("log")


ax[0].set_xticks([150, 220], ['150','220'])
ax[0].xaxis.set_major_formatter(mtick.FormatStrFormatter('%.1f'))
ax[0].xaxis.set_minor_formatter(mtick.ScalarFormatter())
ax[0].tick_params(axis = "both", which = "both",
                  direction='in',width=1.3,)
ax[0].set_xlim(xlim)
ax[0].set_ylim(ylim)

ax[2].set_xticks([150, 220], ['150','220'])
ax[2].xaxis.set_major_formatter(mtick.FormatStrFormatter('%.1f'))
ax[2].xaxis.set_minor_formatter(mtick.ScalarFormatter())
ax[2].tick_params(axis = "both", which = "both",
                  direction='in',width=1.3,)
ax[2].set_xlim(xlim2)
ax[2].set_ylim(ylim2)

ax[0].grid(which="both")
ax[2].grid(which='both')
l = ax[0].legend([(t0,t1), (p1, p2), (e1, e2)], ["Dust - Synch", 'Input sky ', '68% C.L.'], numpoints=1, 
                 loc = "best", fontsize = 12,
               handler_map={tuple: HandlerTuple(ndivide=None)})

ax[0].set_title('GC patch - {} year'.format(dictionaries[0]['effective_duration']),fontsize=fonts)
ax[0].set_ylabel(r'$I(\nu)$ [$\mu$K$_{CMB}$]',fontsize=fonts)
ax[0].set_xlabel(r'$\nu$[GHz]',fontsize=fonts)

ax[2].set_title('QUBIC patch - {} years'.format(dictionaries[0]['effective_duration']),fontsize=fonts)
ax[2].set_ylabel(r'$I(\nu)$ [$\mu$K$_{CMB}$]',fontsize=fonts)
ax[2].set_xlabel(r'$\nu$[GHz]',fontsize=fonts)

# Displaying maps
ax[1].cla()
plt.axes(ax[1])
hp.gnomview(maps_ud[2, -1, :, 0], reso = 15,hold = True, 
            notext = True, title = ' ',
            min = 0,
            max = 0.4*np.max(maps_ud[2, -1, :, 0]), 
            unit = r'$\mu$K$_{CMB}$',
            rot = centers[2])
hp.projscatter(hp.pix2ang(nside, pixs_ud[2]), marker = '*', color = 'r', s = 180)
dpar = 10
dmer = 20
#Watch out, the names are wrong (change it)
mer_coordsG = [centers[2][0] - dmer, centers[2][0], centers[2][0] + dmer]
long_coordsG = [centers[2][1] - 2*dpar, centers[2][1] - dpar, 
                centers[2][1], centers[2][1] + dpar, centers[2][1] + 2 * dpar]
#paralels
for ilong in long_coordsG:
    plt.text(np.deg2rad(mer_coordsG[0] - 14), 1.1*np.deg2rad(ilong), 
             r'{}$\degree$'.format(ilong))
#meridians
for imer in mer_coordsG:
    if imer < 0:
        jmer = imer + 360
        ip, dp = divmod(jmer/15,1)
    else:
        ip, dp = divmod(imer/15,1)
    if imer == 0:
        plt.text(-np.deg2rad(imer + 3), np.deg2rad(long_coordsG[-1] + 6), 
             r'{}$\degree$'.format(int(ip) ))
    else:
        plt.text(-np.deg2rad(imer + 3), np.deg2rad(long_coordsG[-1] + 6), 
             r'{}$\degree$'.format(imer))
             #r'{}h{}m'.format(int(ip), int(round(dp*60))))
#hp.projtext(mer_coordsG[1] + 2, long_coordsG[0] - 6, '$l$',  color = 'k', lonlat=True)
#hp.projtext(mer_coordsG[2] + 13.5, long_coordsG[2] - 1, '$b$', rotation = 0, color = 'k', lonlat=True)
plt.text(0.5,0.13, '$l$', transform=ax[1].transAxes)
plt.text(-0.3,0.57, '$b$', transform=ax[1].transAxes)

ax[3].cla()
plt.axes(ax[3])
hp.gnomview(maps_ud[1, -1, :, 0], reso = 15, hold = True, 
            notext = True, title = ' ',
            unit = r'$\mu$K$_{CMB}$',
            min = 0,
            max = 0.4*np.max(maps_ud[1, -1, :, 0]), 
            rot = centers[0])
hp.projscatter(hp.pix2ang(nside, pixQ_ud),marker = '*', color = 'r', s = 180)

mer_coordsQ = [centers[0][0] - dmer, centers[0][0]+0, centers[0][0] + dmer]
long_coordsQ = [centers[0][1] - 2*dpar, centers[0][1] - dpar, centers[0][1], 
                centers[0][1] + dpar, centers[0][1] + 2 * dpar]
#paralels
for ilong in long_coordsQ:
    plt.text(np.deg2rad(mer_coordsQ[0]-360+29), 1.1*np.deg2rad(ilong+58), r'{:.0f}$\degree$'.format(ilong),)
#meridians
for imer in mer_coordsQ:
    ip, dp = divmod(imer/15,1)
    plt.text(-np.deg2rad(imer-360+48), np.deg2rad(long_coordsQ[-1]+58+7), 
         r'{:.1f}$\degree$'.format(imer))

plt.text(0.5,0.13, '$l$', transform=ax[3].transAxes)
plt.text(-0.3,0.57, '$b$', transform=ax[3].transAxes)

#hp.projtext(mer_coordsQ[0] , long_coordsQ[0] - 6, '$l$',  color = 'k', lonlat=True)
#hp.projtext(mer_coordsQ[2] - 360, long_coordsQ[2] + 10, '$b$', rotation = 0, color = 'k', lonlat=True)
#hp.projtext(-330, -60, '$b$', rotation = 0, color = 'k', lonlat=True)

hp.graticule(dpar = dpar, dmer = dmer, alpha = 0.6, verbose = False)

#plt.tight_layout()
if savefigs:
    plt.savefig('Fig-FI-SED/March2021/NSIDE{}/{}_nrec{}_nside{}_pixQ{}_pixG{}_Intensity_log.svg'.format(nside,
                                                                            "ThermDust",
                                                                            dictionaries[0]['nf_recon'],
                                                                                nside,
                                                           pixQ_ud, pixG_ud), 
            format = 'svg', bbox_inches='tight')
    plt.savefig('Fig-FI-SED/March2021/NSIDE{}/{}_nrec{}_nside{}_pixQ{}_pixG{}_Intensity_log.pdf'.format(nside,
                                                                                "ThermDust",
                                                                               dictionaries[0]['nf_recon'],
                                                                            nside,
                                                           pixQ_ud, pixG_ud), 
            format = 'pdf', bbox_inches='tight')
    plt.savefig('Fig-FI-SED/March2021/NSIDE{}/{}_nrec{}_nside{}_pixQ{}_pixG{}_Intensity_log'.format(nside,
                                                                        "ThermDust", 
                                                                           dictionaries[0]['nf_recon'],
                                                                           nside,pixQ_ud, pixG_ud),
           bbox_inches='tight')
else:
    plt.show()
```

```{python}
#
#                  Polarization
#
fig,ax = plt.subplots(nrows = 1,ncols = 4, figsize = (19,4.5), gridspec_kw = {'wspace': 0.4})
ax = ax.ravel()
plt.subplots_adjust(wspace=0.1)

# Dust galactic center
t0, = ax[0].plot(nus150, np.sqrt(fgr_map_dust_ud[2,:,pixs_ud[2],1] ** 2 + \
                 fgr_map_dust_ud[2,:,pixs_ud[2],2] **2),
           ls = '', marker = 'd', color = 'g',alpha = 0.5, label = 'Dust')
ax[0].plot(nus220, np.sqrt(fgr_map_dust_ud[3,:,pixs_ud[2],1] ** 2 + \
                 fgr_map_dust_ud[3,:,pixs_ud[2],2] **2), 
           marker = 'd', ls = '', color = 'g', alpha = 0.5)
#Synch galactic center
t1, = ax[0].plot(nus150, np.sqrt(fgr_map_synch_ud[2,:,pixs_ud[2],1] ** 2 + \
                                    fgr_map_synch_ud[2,:,pixs_ud[2],2] ** 2), 
                 ls = '', marker = 's', color = 'g', alpha = 0.5, label = 'Synchrotron')
ax[0].plot(nus220, np.sqrt(fgr_map_synch_ud[3,:,pixs_ud[2],1] ** 2 + \
                                    fgr_map_synch_ud[3,:,pixs_ud[2],2] ** 2),
           marker = 's', ls = '', color = 'g', alpha = 0.5)

# Plotting
p1, = ax[0].plot(nus150, 
               np.sqrt(fgr_map_ud[2,:,pixs_ud[2],1] ** 2 + fgr_map_ud[2,:,pixs_ud[2],2] ** 2),
               'ro', lw = 3, label = 'Input sky')
p2, = ax[0].plot(nus220, 
               np.sqrt(fgr_map_ud[3,:,pixs_ud[3],1] ** 2 + fgr_map_ud[3,:,pixs_ud[3],2] ** 2),
               'bo', lw = 3)

e1 = ax[0].fill_between(xarr_mcmc[2], y1 = ySED_fit[2, :, 1] - Perr[2], 
                        y2 = ySED_fit[2, :, 1] + Perr[2], 
                   color = 'r', alpha = 0.3, label = '68% C.L. ')
e2 = ax[0].fill_between(xarr_mcmc[3], y1 = ySED_fit[3, :, 1] - Perr[3], 
                        y2 = ySED_fit[3, :, 1] + Perr[3], 
                   color = 'b', alpha = 0.3)

# Dust galactic center
ax[2].plot(nus150, np.sqrt(fgr_map_dust_ud[0,:,pixs_ud[0],1] ** 2 + \
                 fgr_map_dust_ud[0,:,pixs_ud[0],2] **2),
           ls = '', marker = 'd', color = 'g',alpha = 0.5, label = 'Dust')
ax[2].plot(nus220, np.sqrt(fgr_map_dust_ud[1,:,pixs_ud[0],1] ** 2 + \
                 fgr_map_dust_ud[1,:,pixs_ud[0],2] **2), 
           marker = 'd', ls = '', color = 'g', alpha = 0.5)
#Synch galactic center
ax[2].plot(nus150, np.sqrt(fgr_map_synch_ud[0,:,pixs_ud[0],1] ** 2 + \
                                    fgr_map_synch_ud[0,:,pixs_ud[0],2] ** 2), 
                 ls = '', marker = 's', color = 'g', alpha = 0.5, label = 'Synchrotron')
ax[2].plot(nus220, np.sqrt(fgr_map_synch_ud[1,:,pixs_ud[0],1] ** 2 + \
                                    fgr_map_synch_ud[1,:,pixs_ud[0],2] ** 2),
           marker = 's', ls = '', color = 'g', alpha = 0.5)

ax[2].plot(nus150, 
               np.sqrt(fgr_map_ud[0,:,pixs_ud[0],1] ** 2 + fgr_map_ud[0, :, pixs_ud[0], 2] ** 2),
               'ro', lw = 3)
ax[2].plot(nus220, 
               np.sqrt(fgr_map_ud[1, :, pixs_ud[1], 1] ** 2 + fgr_map_ud[1, :, pixs_ud[1], 2] ** 2),
               'bo', lw = 3)
ax[2].fill_between(xarr_mcmc[0], y1 = ySED_fit[0, :, 1] - Perr[0], 
                   y2 = ySED_fit[0, :, 1] + Perr[0], 
                   color = 'r', alpha = 0.3)
ax[2].fill_between(xarr_mcmc[1], y1 = ySED_fit[1, :, 1] - Perr[1], 
                   y2 = ySED_fit[1, :, 1] + Perr[1], 
                   color = 'b', alpha = 0.3)

# Setting
ax[0].set_title('GC patch - {} year'.format(dictionaries[0]['effective_duration']), fontsize = fonts)
ax[0].set_ylabel(r'$P(\nu)~[\mu$K$_{CMB}$]', fontsize = fonts)
ax[0].set_xlabel(r'$\nu~[GHz]$', fontsize = fonts)
#ax[0].legend(loc = "best", fontsize = 12)
l = ax[0].legend([(t0,t1), (p1, p2), (e1, e2)], ["Dust - Synch", 'Input sky ', '68% C.L.'], numpoints=1, 
                 loc = "best", fontsize = 12,
               handler_map={tuple: HandlerTuple(ndivide=None)})

ax[2].set_xlabel(r'$\nu~[GHz]$', fontsize = fonts)
ax[2].set_ylabel(r'$P(\nu)~[\mu$K$_{CMB}$]', fontsize = fonts)
ax[2].set_title('QUBIC patch - {} years'.format(dictionaries[0]['effective_duration']),fontsize=fonts)

xlim = ax[0].get_xlim()
ylim = ax[0].get_ylim()
xlim2 = ax[2].get_xlim()
ylim2 = ax[2].get_ylim()
ax[0].axvspan(nus_edge150[-1], nus_edge220[0], color = 'k', alpha = greyscale)
ax[0].axvspan(xlim2[0], nus_edge150[0], color = 'k', alpha = greyscale)
ax[0].axvspan(nus_edge220[-1], xlim2[-1], color = 'k', alpha = greyscale)
ax[2].axvspan(nus_edge150[-1], nus_edge220[0], color = 'k', alpha = greyscale)
ax[2].axvspan(xlim2[0], nus_edge150[0], color = 'k', alpha = greyscale)
ax[2].axvspan(nus_edge220[-1], xlim2[-1], color = 'k', alpha = greyscale)

#logscale = True
if logscale:
    ax[0].set_yscale("log")
    ax[2].set_yscale("log")
    ax[0].set_xscale("log")
    ax[2].set_xscale("log")


ax[0].set_xticks([150, 220], ['150','220'])
ax[0].xaxis.set_major_formatter(mtick.FormatStrFormatter('%.1f'))
ax[0].xaxis.set_minor_formatter(mtick.ScalarFormatter())
ax[0].tick_params(axis = "both", which = "both",
                  direction='in',width=1.3,)
ax[0].set_xlim(xlim)
ax[0].set_ylim(ylim)

ax[2].set_xticks([150, 220], ['150','220'])
ax[2].xaxis.set_major_formatter(mtick.FormatStrFormatter('%.1f'))
ax[2].xaxis.set_minor_formatter(mtick.ScalarFormatter())
ax[2].tick_params(axis = "both", which = "both",
                  direction='in',width=1.3,)
ax[2].set_xlim(xlim2)
ax[2].set_ylim(ylim2)

ax[0].grid(which="both")
ax[2].grid(which='both')

# Displaying maps    
plt.axes(ax[1])
auxmapG = np.sqrt(maps_ud[2, 0, :, 1] ** 2 + maps_ud[2, 0, :, 2] ** 2)
auxmapG[~cov_ud[2]] = hp.UNSEEN
hp.gnomview(auxmapG,
            reso = 15, hold = True, notext = True, 
            title = ' ',
            min = 0,
            cbar = True,
            unit = r'$\mu$K$_{CMB}$',
            rot = centers[2])
hp.projscatter(hp.pix2ang(nside, pixs_ud[2]),marker = '*',color = 'r', s = 180)
dpar = 10
dmer = 20
#Watch out, the names are wrong (change it)
mer_coordsG = [centers[2][0] - dmer, centers[2][0], centers[2][0] + dmer]
long_coordsG = [centers[2][1] - 2*dpar, centers[2][1] - dpar, 
                centers[2][1], centers[2][1] + dpar, centers[2][1] + 2 * dpar]
#paralels
for ilong in long_coordsG:
    plt.text(np.deg2rad(mer_coordsG[0] - 14), 1.1*np.deg2rad(ilong), 
             r'{}$\degree$'.format(ilong))
#meridians
for imer in mer_coordsG:
    if imer < 0:
        jmer = imer + 360
        ip, dp = divmod(jmer/15,1)
    else:
        ip, dp = divmod(imer/15,1)
    if imer == 0:
        plt.text(-np.deg2rad(imer + 3), np.deg2rad(long_coordsG[-1] + 6), 
             r'{}$\degree$'.format(int(ip) ))
    else:
        plt.text(-np.deg2rad(imer + 3), np.deg2rad(long_coordsG[-1] + 6), 
             r'{}$\degree$'.format(imer))
             #r'{}h{}m'.format(int(ip), int(round(dp*60))))
#hp.projtext(mer_coordsG[1] + 2, long_coordsG[0] - 6, '$l$',  color = 'k', lonlat=True)
#hp.projtext(mer_coordsG[2] + 13.5, long_coordsG[2] - 1, '$b$', rotation = 0, color = 'k', lonlat=True)
plt.text(0.5,0.13, '$l$', transform=ax[1].transAxes)
plt.text(-0.3,0.57, '$b$', transform=ax[1].transAxes)

plt.axes(ax[3])
auxmapQ = np.sqrt(maps_ud[0, 0, :, 1] ** 2 + maps_ud[0, 0, :, 2] ** 2)
auxmapQ[~cov_ud[0]] = hp.UNSEEN
hp.gnomview(auxmapQ,
            reso = 15, hold = True, notext = True, 
            max = 7,
            min = 0,
            title = ' ',
            cbar = True,
            unit = r'$\mu$K$_{CMB}$',
            rot = centers[0])
hp.projscatter(hp.pix2ang(nside, pixs_ud[0]), marker = '*', color = 'r', s = 180)
mer_coordsQ = [centers[0][0] - dmer, centers[0][0]+0, centers[0][0] + dmer]
long_coordsQ = [centers[0][1] - 2*dpar, centers[0][1] - dpar, 
                centers[0][1], centers[0][1] + dpar, centers[0][1] + 2 * dpar]
#paralels
for ilong in long_coordsQ:
    plt.text(np.deg2rad(mer_coordsQ[0] - 360 + 29), 1.1 * np.deg2rad(ilong + 58), 
             r'{:.0f}$\degree$'.format(ilong),)
#meridians
for imer in mer_coordsQ:
    ip, dp = divmod(imer/15,1)
    plt.text( - np.deg2rad(imer - 360 + 48), np.deg2rad(long_coordsQ[-1] + 58 + 7), 
         r'{:.1f}$\degree$'.format(imer))

hp.graticule(dpar = dpar, dmer = dmer, alpha = 0.6, verbose = False)
plt.text(0.5,0.13, '$l$', transform=ax[3].transAxes)
plt.text(-0.3,0.57, '$b$', transform=ax[3].transAxes)

plt.tight_layout()#plt.tight_layout()

if savefigs: 
    plt.savefig('Fig-FI-SED/March2021/NSIDE{}/{}_nrec{}_nside{}_pixQ{}_pixG{}_Polarization_log.svg'.format(nside,
                                                                "ThermDust",
                                                                dictionaries[0]['nf_recon'], nside,
                                                           pixQ_ud, pixG_ud), 
            format = 'svg', bbox_inches='tight')
    plt.savefig('Fig-FI-SED/March2021/NSIDE{}/{}_nrec{}_nside{}_pixQ{}_pixG{}_Polarization_log.pdf'.format(nside,
                                                                "ThermDust",
                                                                dictionaries[0]['nf_recon'], nside,
                                                           pixQ_ud, pixG_ud), 
            format = 'pdf', bbox_inches='tight')
    plt.savefig('Fig-FI-SED/March2021/NSIDE{}/{}_nrec{}_nside{}_pixQ{}_pixG{}_Polarization_log'.format(nside,
                                                                           "ThermDust",
                                                                            dictionaries[0]['nf_recon'], 
                                                                           nside,pixQ_ud, pixG_ud),
           bbox_inches='tight')
else:
    plt.show()
```

```{python}

```

```{python}

```

```{python}

```

```{python}

```
