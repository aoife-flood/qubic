---
jupyter:
  jupytext:
    formats: ipynb,Rmd
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.14.0
  kernelspec:
    display_name: Python 3 (ipykernel)
    language: python
    name: python3
---

# Inspired from Tutorial2-MapMaking-QUBICPlanck-Multichromatic.Rmd written by Mathias RÃ©gnier
JCH - 20 Jan 2023

```{python}
from __future__ import division
from pyoperators import pcg
from pysimulators import profile

# QUBIC packages
import qubic
from qubicpack.utilities import Qubic_DataDir
from qubic.data import PATH
from qubic.io import read_map
from qubic import QubicSkySim as qss
import Acquisition as Acq

# Display packages
import healpy as hp
import matplotlib.pyplot as plt

# FG-Buster packages
import component_model as c
import mixing_matrix as mm

# General packages
import numpy as np
import pysm3
import warnings
from qubic import QubicSkySim as qss
import pysm3.units as u
from importlib import reload
from pysm3 import utils

from qubic import SpectroImLib as sp
from importlib import reload
import gc
import copy


# PyOperators packages
from pyoperators import (
    BlockColumnOperator, BlockDiagonalOperator, BlockRowOperator,
    CompositionOperator, DiagonalOperator, I, IdentityOperator,
    MPIDistributionIdentityOperator, MPI, proxy_group, ReshapeOperator,
    rule_manager, pcg, Operator)

from pysimulators.interfaces.healpy import HealpixConvolutionGaussianOperator
warnings.filterwarnings("ignore")
# %matplotlib inline

# # %config InlineBackend.figure_format='retina'
from IPython.display import display, HTML
display(HTML("<style>.container { width:95% !important; }</style>"))


```

```{python}
nside = 256
relative_bandwidth = 0.25
band = 220.
seed = 42
noiseless = True

npointings = 3000
Nf_TOD = 20
Nf_recon = 2
fact_sub = 5
```

# TOD Fabrication

```{python}
reload(Acq)

# Repository for dictionary
global_dir = Qubic_DataDir()
print(global_dir)
dictfilename = global_dir + 'dicts/pipeline_demo.dict'

# Read dictionary chosen
d_TOD = qubic.qubicdict.qubicDict()
d_TOD.read_from_file(dictfilename)

d_TOD['nf_recon'] = Nf_TOD
d_TOD['nf_sub'] = Nf_TOD
d_TOD['nside'] = nside
npix=12*d_TOD['nside']**2
d_TOD['RA_center'] = 0
d_TOD['DEC_center'] = -57
center = qubic.equ2gal(d_TOD['RA_center'], d_TOD['DEC_center'])
d_TOD['effective_duration'] = 3
d_TOD['npointings'] = npointings
d_TOD['tol'] = 5e-4
d_TOD['filter_nu'] = band * 1e9
d_TOD['photon_noise'] = not noiseless
d_TOD['noiseless'] = noiseless
d_TOD['config'] = 'FI'
d_TOD['MultiBand'] = True
d_TOD['planck'] = True

print('*************** Noise **************')
print('Noisless:      {}'.format(d_TOD['noiseless']))
print('Photon Noise:  {}'.format(d_TOD['photon_noise']))
print('************************************')

Nbfreq, nus_edge, nus, deltas, Delta, Nbbands = qubic.compute_freq(d_TOD['filter_nu']/1e9, Nfreq=Nf_TOD)
print(nus)
print(nus_edge)

Qubic_sky = qss.Qubic_sky({'cmb':seed, 'Dust':'d0'}, d_TOD)
mapin_TOD = Qubic_sky.get_simple_sky_map()

# Pointing
p = qubic.get_pointing(d_TOD)
# Scene
s = qubic.QubicScene(d_TOD)
# Instrument
q = qubic.QubicMultibandInstrument(d_TOD)
# QUBIC Acquisition
qubic_acquisition = Acq.QubicIntegrated(q, p, s, d_TOD, nus_edge)

H_TOD = qubic_acquisition.get_operator(convolution=True)
n = qubic_acquisition.get_noise()
if noiseless == True:
    n *= 0
print(n)

tod = H_TOD(mapin_TOD) + n

### Free Memory
del H_TOD, s, q, qubic_acquisition, n
gc.collect()
```

# Reconstruction

```{python}
d_formaps = copy.deepcopy(d_TOD)
d_formaps['nf_recon'] = Nf_recon
d_formaps['nf_sub'] = Nf_recon
Qubic_sky = qss.Qubic_sky({'cmb':seed, 'Dust':'d0'}, d_formaps)
mapin = Qubic_sky.get_simple_sky_map()
print(np.shape(mapin))


d = copy.deepcopy(d_TOD)
d['nf_recon'] = Nf_recon
d['nf_sub'] = d['nf_recon'] * fact_sub
Nbfreq, nus_edge, nus, deltas, Delta, Nbbands = qubic.compute_freq(d['filter_nu']/1e9, Nfreq=Nf_recon)


# Scene
s = qubic.QubicScene(d)
# Instrument
q = qubic.QubicMultibandInstrument(d)
# QUBIC Acquisition
qubic_acquisition = Acq.QubicIntegrated(q, p, s, d, nus_edge)

# Planck Acquisition
reload(Acq)
mapin_conv = mapin.copy()

for i in range(Nf_recon):
    print(qubic_acquisition.final_fwhm[i])
    C = HealpixConvolutionGaussianOperator(fwhm=qubic_acquisition.final_fwhm[i])
    mapin_conv[i] = C(mapin[i])
print(mapin_conv.shape)

planck_acquisition = qubic.PlanckAcquisition(band, s, true_sky=mapin_conv[0], mask=None)


# Joint Acquisition
qubicplanck_acquisition = Acq.QubicPlanckMultiBandAcquisition(qubic_acquisition, planck_acquisition)

H = qubicplanck_acquisition.get_operator(convolution=False)

invntt = qubicplanck_acquisition.get_invntt_operator()

H
```

```{python}
### Replacing fake QUBIC TOD with real one
n = qubicplanck_acquisition.get_noise()
if noiseless == True:
    n *= 0

mytod = H(mapin_conv) + n

nelt = len(np.ravel(tod))
mytod[:nelt] = np.ravel(tod)

### Solve PCG
H = qubicplanck_acquisition.get_operator(convolution=False)
A = H.T * invntt * H
b = H.T * invntt * mytod

def get_preconditioner(cov):
    if cov is not None:
        cov_inv = 1 / cov
        cov_inv[np.isinf(cov_inv)] = 0.
        preconditioner = DiagonalOperator(cov_inv, broadcast='rightward')
    else:
        preconditioner = None
    return preconditioner


M = Acq.get_preconditioner(np.ones(12*d['nside']**2))
cov = qubic_acquisition.get_coverage()

tol=1e-4

solution_qubic_planck = pcg(A, b, x0=None, M=M, tol=tol, disp=True, maxiter=200)

del H
gc.collect()
```

```{python}
def display_maps(inputs, outputs, istk, display=True, rot=None, res=None, min=300, max=300, minr=-300, maxr=300, 
                 extra_string='', addnum=False, inside=None):
    
    r = inputs[:, :, istk] - outputs[:, :, istk]
    Nf = outputs.shape[0]
    
    
    stk=['I', 'Q', 'U']
    k=1
    for i in range(Nf): # Nf
        if addnum:
            addstr = '{}'.format(i)
        else:
            addstr=''
        if inside is not None:
            rms_in = np.std(r[i][inside])
            rms_out = np.std(r[i][~inside])
            addstr += '\n $\sigma_Q$={0:5.2g} $\sigma_P$={1:5.2g}'.format(rms_in, rms_out)
        hp.gnomview(inputs[i, :, istk], rot=rot, reso=res, cmap='jet', min=min, max=max, sub=(Nf, 3, k), title='Input'+ extra_string+addstr)
        k+=1
        hp.gnomview(outputs[i, :, istk], rot=rot, reso=res, cmap='jet', min=min, max=max, sub=(Nf, 3, k), title='Output'+ extra_string+addstr)
        k+=1
        hp.gnomview(r[i], rot=rot, reso=res, cmap='jet', min=minr, max=maxr, sub=(Nf, 3, k), title='Residual'+ extra_string+addstr)
        k+=1

inside = (cov/np.max(cov)) >= 0.01
stk = ['I', 'Q', 'U']
for i in range(3):
    fig = plt.figure(figsize=(10, 10))
    mm = 10
    mmr = 1
    if i==0:
        mm=300
    display_maps(mapin_conv, solution_qubic_planck['x'], istk=i, display=True, rot=center, res=15, 
                 min=-mm, max=mm, minr=-mmr, maxr=mmr, extra_string=' {}'.format(stk[i]), addnum=True, inside=inside)
    fig.suptitle('Stokes {}'.format(stk[i]), fontsize=20)
    tight_layout()
    plt.show()
```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```
