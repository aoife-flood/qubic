---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.1
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python}
from IPython.display import set_matplotlib_formats
set_matplotlib_formats('retina')
from IPython.core.display import display, HTML
display(HTML("<style>.container { width:95% !important; }</style>"))

rc('figure',figsize=(16,8))
rc('font',size=12)

from qubic import fibtools as ft
```

```{python}
angspeed = 0.8 # deg/sec
rangeaz = 15.    # we will do a back & forth scan
fwhm = 1. # peak FWHM
locs = [-5., 0., 8.]   # peak locations in az
amps = [0.5, 1., 0.5]   # peak locations in az
sampling = 100. # Hz

tau = 0.3 # time constant in ms

noiseRMS = 0.001


#### True Signal
duration_scan = 4*rangeaz/angspeed
nsamples = int(duration_scan * sampling)
print(nsamples)

tt = np.arange(nsamples)/sampling
onescan = np.linspace(-rangeaz, rangeaz, nsamples//2)
az = np.append(onescan, np.flip(onescan))
direction = np.append(np.ones(nsamples//2), -np.ones(nsamples//2))


signal_true = np.zeros(nsamples)
for l,a in zip(locs, amps):
    signal_true += a * np.exp(-0.5 * (az-l)**2 / (fwhm/2.35))
    


#### Convolve true signal with exponential    
signal_true_conv = ft.exponential_filter1d(signal_true, tau*sampling) + np.random.randn(nsamples)*noiseRMS

#### Now mean and difference
newaz = onescan
true_az_signal = np.zeros(len(newaz))
for l,a in zip(locs, amps):
    true_az_signal += a * np.exp(-0.5 * (newaz-l)**2 / (fwhm/2.35))


# True
mean_true = 0.5 * (signal_true[direction == 1] + np.flip(signal_true[direction == -1]))
diff_true = (signal_true[direction == 1] - np.flip(signal_true[direction == -1]))
diff_true_az = mean_true - true_az_signal


# Convolved
mean_true_conv = 0.5 * (signal_true_conv[direction == 1] + np.flip(signal_true_conv[direction == -1]))
diff_true_conv = (signal_true_conv[direction == 1] - np.flip(signal_true_conv[direction == -1]))
diff_true_conv_az = mean_true_conv - true_az_signal

rc('figure',figsize=(16,8))
subplot(2,2,1)
plot(tt, az)  
xlabel('Time [sec]')
ylabel('Az [deg]')

subplot(2,2,2)
plot(tt, signal_true_conv, label = 'Signal True Convolved', ls='--')
plot(tt, signal_true, label = 'Signal True')
xlabel('time [sec]')
ylabel('Signal [ADU]')
legend()

subplot(2,2,3)
plot(az[direction == 1], signal_true[direction == 1], label='Signal True Direction +', lw=3)
plot(az[direction == -1], signal_true[direction == -1], label='Signal True Direction -', ls='--', lw=3)
xlabel('Az [deg]')
ylabel('Signal [ADU]')
legend()

subplot(2,2,4)
plot(az[direction == 1], signal_true_conv[direction == 1], label='Signal True Conv Direction +', lw=3)
plot(az[direction == -1], signal_true_conv[direction == -1], label='Signal True Conv Direction -', ls='--', lw=3)
xlabel('Az [deg]')
ylabel('Signal [ADU]')
legend()
tight_layout()

rc('figure',figsize=(16,8))
figure()
title('Difference beetween + and - scans')
plot(newaz, mean_true, label='Mean True')
plot(newaz, diff_true, label='Difference True')
plot(newaz, mean_true_conv, label='Mean True Conv')
plot(newaz, diff_true_conv, label='Difference True Conv')
xlabel('Az [deg]')
ylabel('Signal [ADU]')
legend()
tight_layout()

rc('figure',figsize=(16,8))
figure()
title('Reconstructed signal in azimuth')
plot(newaz, true_az_signal, label='Mean True')
plot(newaz, diff_true_az, label='Residuals True - UnCOnv')
plot(newaz, diff_true_conv_az, label='Residuals True - Conv')
xlabel('Az [deg]')
ylabel('Signal [ADU]')
legend()
tight_layout()

```

```{python}
#### Deconvolve
derivative = np.gradient(signal_true_conv, 1./sampling)
signal_deconv = signal_true_conv + derivative*tau        ### Well known proxy for exponential deconvolution


# Deconvolved
mean_deconv = 0.5 * (signal_deconv[direction == 1] + np.flip(signal_deconv[direction == -1]))
diff_deconv = (signal_deconv[direction == 1] - np.flip(signal_deconv[direction == -1]))
diff_true_deconv_az = mean_deconv - true_az_signal



figure()
title('Reconstructed signal in azimuth')
plot(newaz, mean_true, label='Mean True')
plot(newaz, mean_true, alpha=0)
plot(newaz, mean_true_conv - mean_true, label='Residuals Conv - True')
plot(newaz, diff_true_deconv_az, label='Residuals Deconv - True')
xlabel('Az [deg]')
ylabel('Signal [ADU]')
legend()
ylim(-0.1,0.1)
```

So deconvolution works well but clearly amplifies the high-frequency noise (this is unavoidable). If this turns out problematic we may lowpass filter the deconvolved data...

Let's have a look at the TOD power spectra in order to see the HF noise increase:

```{python}
### Signal Power Spectrum
p_true, ff = ft.power_spectrum(tt, signal_true, rebin=True)
p_true_conv, ff = ft.power_spectrum(tt, signal_true_conv, rebin=True)
p_deconv, ff = ft.power_spectrum(tt, signal_deconv, rebin=True)

### Residuals Power Spectrum
r_true_conv, ff = ft.power_spectrum(tt, signal_true_conv - signal_true, rebin=True)
r_deconv, ff = ft.power_spectrum(tt, signal_deconv - signal_true, rebin=True)


subplot(1,2,1)
title('TOD Signal Power Spectrum')
plot(ff, p_true, label = 'Signal True')
plot(ff, p_true_conv, label = 'Signal True Conv')
plot(ff, p_deconv, label = 'Signal Deconv')
xscale('log')
yscale('log')
xlabel('Frequency [Hz]')
ylabel('PSD')
legend()

subplot(1,2,2)
title('TOD Residuals Power Spectrum')
plot(ff, p_true, label = 'True')
plot(ff, r_true_conv, label = 'Residuals (Conv - True)')
plot(ff, r_deconv, label = 'Residuals (Deconv - True)')
xscale('log')
yscale('log')
xlabel('Frequency [Hz]')
ylabel('PSD')
legend()


```

```{python}
#### Deconvolve and low-pass Filter
lo = 1./sampling/10000000
hi = 1./tau
print(lo,hi)
signal_deconv_filt = ft.butter_bandpass_filter(signal_deconv, lo, hi, sampling, order=2)

# Deconvolved and filtered
mean_deconv_filt = 0.5 * (signal_deconv_filt[direction == 1] + np.flip(signal_deconv_filt[direction == -1]))
diff_deconv_filt = (signal_deconv_filt[direction == 1] - np.flip(signal_deconv_filt[direction == -1]))

p_deconv_filt, ff = ft.power_spectrum(tt, signal_deconv_filt, rebin=True)

### Residuals Power Spectrum
r_deconv_filt, ff = ft.power_spectrum(tt, signal_deconv_filt - signal_true, rebin=True)

figure()
title('Reconstructed signal in azimuth')
plot(newaz, mean_true, label='Mean True')
plot(newaz, mean_true, alpha=0)
plot(newaz, mean_true_conv - mean_true, label='Residuals Conv - True')
plot(newaz, mean_deconv - mean_true, label='Residuals Deconv - True')
plot(newaz, mean_deconv_filt - mean_true, label='Residuals DeconvFilt - True')
xlabel('Az [deg]')
ylabel('Signal [ADU]')
legend()
ylim(-0.1,0.1)

figure()
subplot(1,2,1)
title('TOD Signal Power Spectrum')
plot(ff, p_true, label = 'True')
plot(ff, p_true_conv, label = 'True Conv')
plot(ff, p_deconv, label = 'Deconv')
plot(ff, p_deconv_filt, label = 'Deconv Filt')
xscale('log')
yscale('log')
xlabel('Frequency [Hz]')
ylabel('PSD')
legend()

subplot(1,2,2)
title('TOD Residuals Power Spectrum')
plot(ff, p_true, label = 'True')
plot(ff, r_true_conv, label = 'Residuals True Conv')
plot(ff, r_deconv, label = 'Residuals Deconv')
plot(ff, r_deconv_filt, label = 'Residausl Deconv Filt')
xscale('log')
yscale('log')
xlabel('Frequency [Hz]')
ylabel('PSD')
legend()
```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

# Trying with QUBIC data from Salta
Data sent by Steve as Pickle files: 
- `/Users/hamilton/Downloads/az.pickle`
- `/Users/hamilton/Downloads/tod_ASIC1_TES33.pickle`


```{python}
import pickle
fileaz = '/Users/hamilton/Downloads/az.pickle'
filetod = '/Users/hamilton/Downloads/tod_ASIC1_TES33.pickle'

with open(fileaz, 'rb') as f:
    taz, az = pickle.load(f)

with open(filetod, 'rb') as f:
    t, tod = pickle.load(f)

newaz = np.interp(t, taz, az)    
sampling = 1./np.mean((t-np.roll(t,1))[1:-1])

t -= t[0]

subplot(1,2,1)
plot(t, newaz)

subplot(1,2,2)
plot(t, tod)

figure()
plot(newaz, tod)
```

```{python}
tmin = 11470
tmax = 11610

ok = (t>tmin) & (t<tmax)
subplot(1,2,1)
plot(t[ok], newaz[ok])
subplot(1,2,2)
plot(t[ok], tod[ok])

figure()
subplot(1,2,1)
plot(newaz[ok], tod[ok])


myt = t[ok]
myaz = newaz[ok]
mytod = tod[ok]

iii = np.arange(len(myt))

okp = iii < len(iii)//2
okm = iii >= len(iii)//2

subplot(1,2,2)
plot(myaz[okp], mytod[okp])
plot(myaz[okm], mytod[okm])

```

```{python}
tauvals = np.linspace(0., 1, 20)
doplot = False
chi2 = np.zeros(len(tauvals))
for i in range(len(tauvals)):
    print(i)
    tau = tauvals[i]
    sampling = 1./np.mean((myt-np.roll(myt,1))[1:-1])
    dtod_dt = np.gradient(mytod, 1./sampling)
    tod_deconv = mytod + dtod_dt * tau      

#     lo = 1./10000000
#     hi = 1./tau
#     print(lo,hi)
#     tod_deconv_filt = ft.butter_bandpass_filter(tod_deconv, lo, hi, sampling, order=2)



    ### Rebin in azimuth bins
    nbins = 150
    azbins, scanp, daz, dscanp, _ = ft.profile(myaz[okp], mytod[okp], rng=[-20,20], nbins=nbins, plot=False)
    azbins, scanm, daz, dscanm, _ = ft.profile(myaz[okm], mytod[okm], rng=[-20,20], nbins=nbins, plot=False)

    azbins, scanp_deconv, daz, dscanp, _ = ft.profile(myaz[okp], tod_deconv[okp], rng=[-20,20], nbins=nbins, plot=False)
    azbins, scanm_deconv, daz, dscanp, _ = ft.profile(myaz[okm], tod_deconv[okm], rng=[-20,20], nbins=nbins, plot=False)


    chi2[i] = np.sum((scanp_deconv-scanm_deconv)**2)

    if doplot:
        subplot(1,2,1)
        plot(azbins, scanp, label='Rebin +')
        plot(azbins, scanm, label='Rebin -')
        legend()

        subplot(1,2,2)
        plot(azbins, scanp_deconv, label = 'Rebin Deconvolved +')
        plot(azbins, scanm_deconv, label = 'Rebin Deconvolved -')
        legend()

        figure()
        plot(azbins, scanp-scanm, label='Diff Raw')
        plot(azbins, scanp_deconv-scanm_deconv, label='Diff Deconv')
        legend()
```

```{python}
plot(tauvals, chi2)
```

```{python}

```

```{python}

```
