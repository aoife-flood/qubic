---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.14.0
  kernelspec:
    display_name: Python 3 (ipykernel)
    language: python
    name: python3
---

```{python}
from qubic import fibtools as ft
import fitting as fit
from importlib import reload

rc('figure',figsize=(10,6))
rc('font',size=12)

```

```{python}
######### iminuit direct
x = np.linspace(0,1,10)
sig = np.ones(len(x)) * 1.
errors = np.random.randn(len(x)) * sig
y = 3*x+1 + errors

def linearfit(x, pars):
    return pars[0] + pars[1] * x

import iminuit
from iminuit.cost import LeastSquares
myminimizer = LeastSquares(x, y, errors, linearfit)
m = iminuit.Minuit(myminimizer, [0., 0.], name=None)
m.migrad()
m.hesse()

print(m)

errorbar(x, y, yerr=sig, fmt='ko')
plot(x, linearfit(x, m.values), 'r', lw=2)
```

```{python}
### Use the fitting.py library 

reload(fit)

x = np.linspace(0,1,10)
sig = np.ones(len(x)) * 1.
errors = np.random.randn(len(x)) * sig
y = 3*x+1 + errors

def linearfit(x, pars):
    return pars[0] + pars[1] * x


mydata = fit.Data(x,y,sig, linearfit, pnames=['a', 'b'])

guess = [0., 0.]
mydata.fit_minuit(guess)
mydata.plot()
```

# 2D fitting

```{python}
x = np.linspace(-10,10,101)
y = x.copy()
xx,yy = meshgrid(x,y)

signoise = 0.3
mapxy = 3. * np.exp(-0.5 * ((xx-2)**2 + (yy+3)**2)/0.5) + np.random.randn(*np.shape(xx))*signoise

imshow(mapxy, origin='lower', extent=[np.min(x), np.max(x), np.min(y), np.max(y)])
xlabel('Arcminutes')
ylabel('Arcminutes')
colorbar()

```

```{python}
class gauss2dfit:
    def __init__(self, xx, yy):
        self.xx = xx
        self.yy = yy
    def __call__(self, x, pars):
        amp, xc, yc, sig = pars
        mygauss = amp * np.exp(-0.5*((self.xx-xc)**2+(self.yy-yc)**2)/sig**2)
        return np.ravel(mygauss)
        

guess = np.array([np.max(mapxy), 0.,0., 1.])

g2d = gauss2dfit(xx, yy)


mm, ss = ft.meancut(mapxy, 3)

data = fit.Data(np.ravel(xx), np.ravel(mapxy), np.ravel(xx)*0+ss, g2d)
m, ch2, ndf = data.fit_minuit(guess)

subplot(2,3,1)
imshow(mapxy, origin='lower', extent=[np.min(x), np.max(x), np.min(y), np.max(y)])
xlabel('Arcminutes')
ylabel('Arcminutes')
colorbar()

fitted = np.reshape(g2d(x, m.values), (len(x), len(x)))

subplot(2,3,2)
imshow(fitted, origin='lower', extent=[np.min(x), np.max(x), np.min(y), np.max(y)])
xlabel('Arcminutes')
ylabel('Arcminutes')
colorbar()

subplot(2,3,3)
imshow(mapxy-fitted, origin='lower', extent=[np.min(x), np.max(x), np.min(y), np.max(y)])
xlabel('Arcminutes')
ylabel('Arcminutes')
colorbar()

tight_layout()
```

```{python}

```

```{python}


```

```{python}
npix = 20
xpix = np.linspace(0,1,npix)

x0 = 0.5
maxy = 1.
α = -maxy / (x0-x0**2)
β = - α
amp = 1.
w0 = 0.1
ph = 0.3

truey = α*xpix**2 + β*xpix + amp*np.sin(xpix/w0+2*np.pi * ph)

plot(xpix, truey)



###########




ndet = 5
nsamples = 20
sig = 0.1

intercal = np.random.rand(ndet)+0.5
H = np.zeros((ndet*nsamples, npix))
for i in range(npix):
    H[:,i] = np.random.randint(0,npix, size=nsamples*ndet)
    
    
alltod = np.dot(H, truey) + np.random.randn(ndet*nsamples)*sig

for k in range(ndet):
    alltod[k*ndet:(k+1)*ndet] *= intercal[k]


mymap2 = np.linalg.inv(H.T@H)@H.T@alltod

plot(xpix, mymap2, 'ro')

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```
