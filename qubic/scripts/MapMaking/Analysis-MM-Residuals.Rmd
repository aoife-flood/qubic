---
jupyter:
  jupytext:
    formats: ipynb,Rmd
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.14.4
  kernelspec:
    display_name: Python 3 (ipykernel)
    language: python
    name: python3
---

```{python}
import numpy as np
import matplotlib.pyplot as plt
import pickle
import healpy as hp
from pysimulators.interfaces.healpy import HealpixConvolutionGaussianOperator

CMB_CL_FILE = '/Users/mregnier/Desktop/PhD Regnier/mypackages/Cls_Planck2018_'

def cl2dl(ell, cl):

    dl=np.zeros(ell.shape[0])
    for i in range(ell.shape[0]):
        dl[i]=(ell[i]*(ell[i]+1)*cl[i])/(2*np.pi)
    return dl
def give_cl_cmb(r=0, Alens=1.):
    power_spectrum = hp.read_cl(CMB_CL_FILE+'lensed_scalar.fits')[:,:4000]
    if Alens != 1.:
        power_spectrum[2] *= Alens
    if r:
        power_spectrum += r * hp.read_cl(CMB_CL_FILE+'unlensed_scalar_and_tensor_r1.fits')[:,:4000]
    return power_spectrum

path = 'data_mm/'

with open(path+f'MM_band220_bandpasscorrectionFalse_Nrec2_Nsub4_Ntod100_correction_conv0.0deg_noiseFalse.pkl', 'rb') as f:
    data = pickle.load(f)
print(data.keys())
```

```{python}
ell = np.arange(2, 4000, 1)
Dls = cl2dl(ell, give_cl_cmb(r=0, Alens=1)[2])
```

```{python}
allnsub = [4, 8]#[5, 10, 15, 20, 30]

plt.figure(figsize=(10, 8))

plt.plot(ell, Dls, label=r'Theoretical CMB | r = 0, $A_{lens}$ = 1')

for ii, i in enumerate(allnsub):
    with open(path+f'MM_band220_bandpasscorrectionFalse_Nrec2_Nsub{i}_Ntod100_correction_conv0.0deg_noiseFalse.pkl', 'rb') as f:
        data = pickle.load(f)
    plt.plot(data['leff'], data['Dl_BB'], '-o', label=f'Nsub = {i}')
plt.xlim(20, 500)
plt.yscale('log')
plt.ylim(1e-5, 1e-1)
plt.legend(frameon=False, fontsize=12)
plt.title(r'$N_{TOD}$' + f' = {100}')

plt.show()
```

```{python}
Dls_binned = np.interp(data['leff'], ell, Dls)
```

```{python}
Dls_bias = np.zeros((len(allnsub), 13))
for ii, i in enumerate(allnsub):
    with open(path+f'MM_band220_bandpasscorrectionFalse_Nrec2_Nsub{i}_Ntod100_correction_conv0.0deg_noiseFalse.pkl', 'rb') as f:
        data = pickle.load(f)
    Dls_bias[ii] = Dls_binned + data['Dl_BB']
```

```{python}
def chi2(theta, d, leff, ell_theo, Dl_theo):
    r = theta
    Alens = 1
    Dl_simu = cl2dl(ell_theo, give_cl_cmb(r=r, Alens=Alens)[2])
    Dl_simu = np.interp(leff, ell_theo, Dl_simu)
    
    return np.sum((Dl_simu - d)**2)
```

```{python}
from scipy.optimize import minimize
r = np.zeros(len(allnsub))
for ii, i in enumerate(allnsub):
    r[ii]=minimize(chi2, x0=np.zeros(1), args=(Dls_bias[ii], data['leff'], ell, Dls), tol=1e-10, method='BFGS').x
    print(r[ii])
```

```{python}
allnsub = [4, 8]#[5, 10, 15, 20, 30]

plt.figure(figsize=(10, 8))

plt.plot(ell, Dls, label=r'Theoretical CMB | r = 0, $A_{lens}$ = 1')

for ii, i in enumerate(allnsub):
    with open(path+f'MM_band220_bandpasscorrectionFalse_Nrec2_Nsub{i}_Ntod100_correction_conv0.0deg_noiseFalse.pkl', 'rb') as f:
        data = pickle.load(f)
    
    plt.plot(data['leff'], data['Dl_BB'], '-o', label=f'Nsub = {i} | '+r'$r_{bias}$ = '+f'{r[ii]:.4f}')

plt.xlim(20, 500)
plt.yscale('log')
plt.ylim(1e-5, 1e-1)
plt.legend(frameon=False, fontsize=12)
plt.title(r'$N_{TOD}$' + f' = {100}')

plt.show()
```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```

```{python}

```
